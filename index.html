<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outlet Tera</title>
    <link rel="icon" href="./image_1_.png" type="image/x-icon">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="./image_1_.png" alt="Logo" class="logo">
        </div>
        <div class="filters">
            <input type="text" id="searchInput" placeholder="Buscar por nome..." oninput="handleSearch()" aria-label="Buscar por nome">
            <select id="tipoSelect" onchange="handleFilterChange()" aria-label="Filtrar por tipo">
                <option value="Todos">Todos</option>
            </select>
            <select id="priceSortSelect" onchange="handleFilterChange()" aria-label="Ordenar por preço">
                <option value="default">Ordenar por</option>
                <option value="asc">Menor preço</option>
                <option value="promo">Super Promoção</option>
            </select>
        </div>
        <p class="product-count" id="productCount" aria-live="polite"></p>
    </header>
    <div class="container" id="container" aria-live="polite"></div>
    <div class="pagination" id="pagination" aria-live="polite"></div>

    <!-- Modal de Termos e Condições -->
    <div class="modal" id="termsModal">
        <div class="modal-content">
            <h2>Termos e Condições</h2>
            <p>Leia os termos e condições para prosseguir com a reserva do produto.</p>
            <p>Ao continuar, você concorda com os seguintes termos:</p>
            <ul>
                <li>O comprador deve realizar a reserva do produto diretamente pelo site.</li>
                <li>A reserva será enviada ao responsável, que tomará as providências necessárias para preparar o produto.</li>
                <li>Assim que o produto estiver pronto, o comprador receberá o link de pagamento por e-mail ou WhatsApp.</li>
                <li>O comprador deve realizar o pagamento e enviar o comprovante.</li>
                <li>Após a confirmação do pagamento, seguiremos com a separação do produto e a emissão da nota fiscal.</li>
                <li>Trabalhamos com D+1, ou seja, após o pagamento efetuado e a nota fiscal gerada, o produto estará disponível para retirada no próximo dia.</li>
                <li>A retirada do produto pode ser feita até as 17h.</li>
                <li>Retiradas após este horário só poderão ser feitas no dia seguinte.</li>
                <li>Todos os produtos têm uma garantia de 90 dias a partir da data de retirada.</li>
            </ul>
            <button onclick="acceptTerms()">Aceitar e Continuar</button>
            <button onclick="closeTermsModal()">Cancelar</button>
        </div>
    </div>

    <!-- Modal de Reserva -->
    <div class="modal" id="reservationModal">
        <div class="modal-content">
            <h2>Reservar Produto</h2>
            <input type="text" id="fullName" placeholder="Nome Completo" required aria-label="Nome Completo">
            <input type="text" id="cpf" placeholder="CPF (ex: 123.456.789-00)" required aria-label="CPF">
            <input type="email" id="email" placeholder="E-mail" required aria-label="E-mail">
            <input type="text" id="company" placeholder="Empresa" required aria-label="Empresa">
            <textarea id="address" placeholder="Endereço" required aria-label="Endereço"></textarea>
            <button onclick="submitReservation()">Enviar</button>
            <button onclick="closeModal()">Cancelar</button>
        </div>
    </div>

    <!-- Modal de Sucesso -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <h2>Produto outlet reservado com sucesso!</h2>
            <p>Para finalizar sua compra, realize o pagamento e retirada de sua nota fiscal na sala Terabyte, com Erick, ou pelo WhatsApp!</p>
            <p>WhatsApp: <a href="#" id="whatsappLink" target="_blank">Clique aqui para conversar no WhatsApp</a></p>
            <button onclick="closeSuccessModal()">Fechar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script>
        let currentPage = 1;
        const itemsPerPage = 8;
        let filteredProducts = [];
        let allProducts = [];
        let selectedProduct = null;

        // Função para buscar produtos e aplicar filtros e ordenações
        async function fetchProdutos(selectedTipo, searchQuery, priceSort, page = 1) {
            try {
                const response = await fetch('https://sheets.googleapis.com/v4/spreadsheets/1_ODPEKD1yor2wjFncaYEp7B5CVFmXRuiEwyOjcqOwcM/values/Produtos!A1:L1000?key=AIzaSyAIB-qCRdOAgEJYuPAxNTEsoR2Ijt33-TE');
                const data = await response.json();
                const produtos = data.values.slice(1);

                allProducts = produtos;

                const soldResponse = await axios.get('https://parseapi.back4app.com/classes/Produtos', {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Parse-Application-Id': '1WzazzMciNH2dmPTjfGrSXOt4tVMsLp849DtX6YU',
                        'X-Parse-REST-API-Key': 'QCmYv8iVNOkHYkRh6Cvd00XfBZ7PkVeowrpsEgrU'
                    }
                });
                const soldData = soldResponse.data.results;

                const soldMap = new Map();
                soldData.forEach(item => {
                    soldMap.set(item.ean, item.status);
                });

                filteredProducts = produtos.filter(produto => {
                    const nomeProduto = produto[2].toLowerCase();
                    const searchQueryLower = searchQuery.toLowerCase();
                    const isSold = soldMap.get(produto[1]) === 'Vendido';
                    produto[6] = isSold ? 'Vendido' : produto[6];
                    return produto[6] === "ADICIONADO PARA VENDA" &&
                           (selectedTipo === 'Todos' || produto[3] === selectedTipo) &&
                           nomeProduto.includes(searchQueryLower);
                });

                if (priceSort === 'asc') {
                    filteredProducts.sort((a, b) => parseFloat(a[7].replace('R$', '').replace('.', '').replace(',', '.')) -
                                                      parseFloat(b[7].replace('R$', '').replace('.', '').replace(',', '.')));
                } else if (priceSort === 'promo') {
                    filteredProducts = filteredProducts.filter(produto => produto[10] === 'SIM');
                }
                populateCategoryOptions(allProducts);
                updatePagination(filteredProducts, page);
            } catch (error) {
                console.error('Erro ao buscar dados da planilha:', error);
                alert('Erro ao buscar dados da planilha. Por favor, tente novamente.');
            }
        }

        // Função para popular as opções de categoria
        function populateCategoryOptions(produtos) {
            const uniqueCategories = Array.from(new Set(produtos.map(produto => produto[3])));
            const tipoSelect = document.getElementById('tipoSelect');
            tipoSelect.innerHTML = '<option value="Todos">Todos</option>';
            uniqueCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                tipoSelect.appendChild(option);
            });
        }

        // Função para atualizar a paginação e exibição dos produtos
        function updatePagination(products, page) {
            const totalItems = products.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            currentPage = page;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const itemsToShow = products.slice(startIndex, endIndex);

            const container = document.getElementById('container');
            container.innerHTML = '';
            itemsToShow.forEach(produto => {
                const card = createProductCard(produto);
                container.appendChild(card);
            });

            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => {
                    updatePagination(products, i);
                    scrollToTop();
                };
                if (i === currentPage) {
                    button.classList.add('active');
                }
                pagination.appendChild(button);
            }
        }

        // Função para rolar para o topo da página
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Função para criar card de produto
        function createProductCard(produto) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <img src="${produto[11]}" alt="${produto[2]}" class="product-image">
                <h3>${produto[2]}</h3>
                <p>${produto[3]}</p>
                <p>${produto[7]}</p>
                <button class="reserve-btn" onclick="showTermsModal(${JSON.stringify(produto)})">Reservar</button>
            `;
            return card;
        }

        // Funções de exibição e manipulação dos modais
        function showTermsModal(produto) {
            selectedProduct = produto;
            document.getElementById('termsModal').style.display = 'block';
        }

        function closeTermsModal() {
            document.getElementById('termsModal').style.display = 'none';
        }

        function acceptTerms() {
            closeTermsModal();
            showReservationModal();
        }

        function showReservationModal() {
            document.getElementById('reservationModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('reservationModal').style.display = 'none';
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        // Função para submeter reserva
        async function submitReservation() {
            const fullName = document.getElementById('fullName').value;
            const cpf = document.getElementById('cpf').value;
            const email = document.getElementById('email').value;
            const company = document.getElementById('company').value;
            const address = document.getElementById('address').value;

            if (!fullName || !cpf || !email || !company || !address) {
                alert('Todos os campos são obrigatórios.');
                return;
            }

            try {
                const reservationData = {
                    nome: fullName,
                    cpf,
                    email,
                    empresa: company,
                    endereco: address,
                    produto: selectedProduct[2],
                    ean: selectedProduct[1],
                    valor: selectedProduct[7]
                };

                await axios.post('https://parseapi.back4app.com/classes/Reservas', reservationData, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Parse-Application-Id': '1WzazzMciNH2dmPTjfGrSXOt4tVMsLp849DtX6YU',
                        'X-Parse-REST-API-Key': 'QCmYv8iVNOkHYkRh6Cvd00XfBZ7PkVeowrpsEgrU'
                    }
                });

                closeModal();
                document.getElementById('successModal').style.display = 'block';
            } catch (error) {
                console.error('Erro ao enviar reserva:', error);
                alert('Erro ao enviar reserva. Tente novamente.');
            }
        }

        // Funções para lidar com filtros e busca
        function handleSearch() {
            const searchQuery = document.getElementById('searchInput').value;
            handleFilterChange(searchQuery);
        }

        function handleFilterChange(searchQuery = '') {
            const selectedTipo = document.getElementById('tipoSelect').value;
            const priceSort = document.getElementById('priceSortSelect').value;
            fetchProdutos(selectedTipo, searchQuery, priceSort, currentPage);
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetchProdutos('Todos', '', 'default', currentPage);
        });
    </script>
</body>
</html>
