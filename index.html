<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outlet Tera</title>
    <link rel="icon" href="./image_1_.png" type="image/x-icon">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="logo-container">
            <img src="./image_1_.png" alt="Logo" class="logo">
        </div>
        <div class="filters">
            <input type="text" id="searchInput" placeholder="Buscar por nome..." oninput="handleSearch()" aria-label="Buscar por nome">
            <select id="tipoSelect" onchange="handleFilterChange()" aria-label="Filtrar por tipo">
                <option value="Todos">Todos</option>
            </select>
            <select id="priceSortSelect" onchange="handleFilterChange()" aria-label="Ordenar por preço">
                <option value="default">Ordenar por</option>
                <option value="asc">Menor preço</option>
                <option value="promo">Super Promoção</option>
            </select>
        </div>
        <p class="product-count" id="productCount"></p>
    </header>
    <div class="container" id="container"></div>
    <div class="pagination" id="pagination"></div>

    <div class="modal" id="reservationModal">
        <div class="modal-content">
            <h2>Reservar Produto</h2>
            <input type="text" id="fullName" placeholder="Nome Completo" required>
            <input type="text" id="cpf" placeholder="CPF" required>
            <input type="email" id="email" placeholder="E-mail" required>
            <input type="text" id="company" placeholder="Empresa" required>
            <textarea id="address" placeholder="Endereço" required></textarea>
            <button onclick="submitReservation()">Enviar</button>
            <button onclick="closeModal()">Cancelar</button>
        </div>
    </div>

    <div class="modal" id="successModal">
        <div class="modal-content">
            <h2>Produto outlet reservado com sucesso!</h2>
            <p>Para finalizar sua compra, realize o pagamento e retirada de sua nota fiscal na sala Terabyte, com Erick, ou pelo WhatsApp!</p>
            <p>WhatsApp: <a href="#" id="whatsappLink" target="_blank">Clique aqui para conversar no WhatsApp</a></p>
            <button onclick="closeSuccessModal()">Fechar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
    <script>
        let currentPage = 1;
        const itemsPerPage = 8;
        let filteredProducts = [];
        let selectedProduct = null;
        let debounceTimeout = null;

        // Função para buscar produtos com cache local
        async function fetchProdutosWithCache(selectedTipo, searchQuery, priceSort, page = 1) {
            const cacheKey = `produtos_${selectedTipo}_${searchQuery}_${priceSort}`;
            const cachedData = sessionStorage.getItem(cacheKey);

            if (cachedData) {
                console.log("Dados carregados do cache");
                updatePagination(JSON.parse(cachedData), page);
                return;
            }

            try {
                const response = await fetch('https://sheets.googleapis.com/v4/spreadsheets/1_ODPEKD1yor2wjFncaYEp7B5CVFmXRuiEwyOjcqOwcM/values/Produtos!A1:L1000?key=AIzaSyAIB-qCRdOAgEJYuPAxNTEsoR2Ijt33-TE');
                const data = await response.json();
                const produtos = data.values.slice(1);

                const soldResponse = await axios.get('https://parseapi.back4app.com/classes/Produtos', {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Parse-Application-Id': '1WzazzMciNH2dmPTjfGrSXOt4tVMsLp849DtX6YU',
                        'X-Parse-REST-API-Key': 'QCmYv8iVNOkHYkRh6Cvd00XfBZ7PkVeowrpsEgrU'
                    }
                });
                const soldData = soldResponse.data.results;

                const soldMap = new Map();
                soldData.forEach(item => {
                    soldMap.set(item.ean, item.status);
                });

                // Processamento local dos produtos
                filteredProducts = produtos.filter(produto => {
                    const isSold = soldMap.get(produto[1]) === 'Vendido';
                    produto[6] = isSold ? 'Vendido' : produto[6];
                    return produto[6] === "ADICIONADO PARA VENDA" &&
                        (selectedTipo === 'Todos' || produto[3] === selectedTipo) &&
                        produto[2].toLowerCase().includes(searchQuery.toLowerCase());
                });

                if (priceSort === 'asc') {
                    filteredProducts.sort((a, b) => parseFloat(a[7].replace('R$', '').replace('.', '').replace(',', '.')) - parseFloat(b[7].replace('R$', '').replace('.', '').replace(',', '.')));
                } else if (priceSort === 'promo') {
                    filteredProducts = filteredProducts.filter(produto => produto[10] === 'SIM');
                }

                // Armazenar os produtos no cache
                sessionStorage.setItem(cacheKey, JSON.stringify(filteredProducts));
                updatePagination(filteredProducts, page);

            } catch (error) {
                console.error('Erro ao buscar dados da planilha:', error);
                alert('Erro ao buscar dados da planilha. Por favor, tente novamente.');
            }
        }

        function updatePagination(products, page) {
            const totalItems = products.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            currentPage = page;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const itemsToShow = products.slice(startIndex, endIndex);

            const container = document.getElementById('container');
            container.innerHTML = '';
            itemsToShow.forEach(produto => {
                const card = createProductCard(produto);
                container.appendChild(card);
            });

            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.onclick = () => {
                    updatePagination(products, i);
                    scrollToTop(); // Rola para o topo após mudar a página
                };
                if (i === currentPage) {
                    button.classList.add('active');
                }
                pagination.appendChild(button);
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function createProductCard(produto) {
            const card = document.createElement('div');
            card.className = 'card';

            const nome = document.createElement('h2');
            nome.textContent = produto[2];
            card.appendChild(nome);

            const ean = document.createElement('p');
            ean.textContent = `EAN: ${produto[1]}`;
            card.appendChild(ean);

            const tipoElement = document.createElement('p');
            tipoElement.textContent = `Tipo: ${produto[3]}`;
            card.appendChild(tipoElement);

            const codigo = document.createElement('p');
            codigo.textContent = `Código: ${produto[4]}`;
            card.appendChild(codigo);

            const situacao = document.createElement('p');
            situacao.textContent = `Situação: ${produto[5]}`;
            card.appendChild(situacao);

            const imagem = document.createElement('img');
            imagem.src = produto[9];
            imagem.alt = `Imagem do ${produto[2]}`;
            card.appendChild(imagem);

            const valor = document.createElement('p');
            valor.className = 'price';
            valor.textContent = `${produto[7]}`;
            card.appendChild(valor);

            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'button-container';

            if (produto[6] === 'Vendido') {
                const soldText = document.createElement('p');
                soldText.className = 'sold';
                soldText.textContent = 'Vendido';
                buttonContainer.appendChild(soldText);
            } else {
                const reservarButton = document.createElement('button');
                reservarButton.textContent = 'Reservar';
                reservarButton.onclick = () => openModal(produto, card);
                buttonContainer.appendChild(reservarButton);
            }

            // Add Super Promoção badge if marked as "SIM" in column K
            if (produto[10] === 'SIM') {
                const superPromoBadge = document.createElement('div');
                superPromoBadge.className = 'super-promo-badge';
                superPromoBadge.textContent = 'Super Promoção';
                card.appendChild(superPromoBadge);
            }

            card.appendChild(buttonContainer);

    // Add star indicator based on column L
    if (produto[11]) {
        const starIndicator = document.createElement('div');
        starIndicator.className = 'star-indicator';
        starIndicator.textContent = '⭐'.repeat(parseInt(produto[11])); // Adjust the number of stars based on column L
        card.appendChild(starIndicator);
    }

    return card;
}

        function handleFilterChange() {
            const selectedTipo = document.getElementById('tipoSelect').value;
            const searchQuery = document.getElementById('searchInput').value;
            const priceSort = document.getElementById('priceSortSelect').value;
            fetchProdutosWithCache(selectedTipo, searchQuery, priceSort);
        }

        // Função para lidar com debounce na busca
        function handleSearch() {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                handleFilterChange();
            }, 300); // 300ms de atraso para otimizar o número de chamadas
        }

        function openModal(produto, card) {
            selectedProduct = { produto, card };
            document.getElementById('reservationModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('reservationModal').style.display = 'none';
        }

        function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
        }

        async function submitReservation() {
            const fullName = document.getElementById('fullName').value;
            const cpf = document.getElementById('cpf').value;
            const email = document.getElementById('email').value;
            const company = document.getElementById('company').value;
            const address = document.getElementById('address').value;

            if (!fullName || !cpf || !email || !company || !address) {
                alert('Por favor, preencha todos os campos!');
                return;
            }

            try {
                const reservationData = {
                    nome: fullName,
                    cpf: cpf,
                    email: email,
                    empresa: company,
                    endereco: address,
                    ean: selectedProduct.produto[1],
                    status: 'Vendido'
                };

                await axios.post('https://parseapi.back4app.com/classes/Produtos', reservationData, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Parse-Application-Id': '1WzazzMciNH2dmPTjfGrSXOt4tVMsLp849DtX6YU',
                        'X-Parse-REST-API-Key': 'QCmYv8iVNOkHYkRh6Cvd00XfBZ7PkVeowrpsEgrU'
                    }
                });

                closeModal();
                document.getElementById('successModal').style.display = 'block';

                // Atualize o estado do produto localmente sem recarregar todos os dados
                const card = selectedProduct.card;
                const soldText = document.createElement('p');
                soldText.className = 'sold';
                soldText.textContent = 'Vendido';
                card.querySelector('.button-container').innerHTML = '';
                card.querySelector('.button-container').appendChild(soldText);

            } catch (error) {
                console.error('Erro ao reservar o produto:', error);
                alert('Erro ao reservar o produto. Por favor, tente novamente.');
            }
        }

        function fillTipoFilter() {
            // Função para preencher o filtro de tipo com os tipos de produtos únicos
            fetch('https://sheets.googleapis.com/v4/spreadsheets/1_ODPEKD1yor2wjFncaYEp7B5CVFmXRuiEwyOjcqOwcM/values/Produtos!D2:D1000?key=AIzaSyAIB-qCRdOAgEJYuPAxNTEsoR2Ijt33-TE')
                .then(response => response.json())
                .then(data => {
                    const tipoSet = new Set();
                    data.values.forEach(row => {
                        tipoSet.add(row[0]);
                    });

                    const tipoSelect = document.getElementById('tipoSelect');
                    tipoSet.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo;
                        option.textContent = tipo;
                        tipoSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar tipos de produtos:', error);
                });
        }

        window.onload = () => {
            fetchProdutosWithCache('Todos', '', 'default');
            fillTipoFilter();
        };
    </script>
</body>
</html>
